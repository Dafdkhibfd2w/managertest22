<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NEW DELI â€¢ ×—×©×‘×•× ×™×•×ª</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
<link rel="stylesheet" href="/css/style.css?v=2" />
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2b5329">
<link rel="icon" href="/icons/icon-512.png" type="image/png">


</head>
<body class="theme-dark-premium">
  <div id="globalLoader">
    <div class="spinner"></div>
    <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
  </div>

  <div id="pageContent" style="display:none">
    <header class="brandbar">
      <span class="brand-title">NEW DELI</span>
      <div class="brandbar-right">
        <button id="notifToggle" class="icon-btn"><i id="notifIcon" style="font-size: 20px;" class="fa-solid fa-bell"></i></button>
        <span class="burger" id="burger">&#9776;</span>
        <button id="themeToggle" class="icon-btn">ğŸŒ™/â˜€ï¸</button>
      </div>
    </header>

    <nav class="mobile-nav" id="mobileNav">
      <button id="closeNav" class="close-btn">âœ–</button>
      <ul>
        <li><a href="/"><span class="icon">ğŸ </span> ×“×£ ×”×‘×™×ª</a></li>
        <li><a href="/create"><span class="icon">ğŸ—“ï¸</span> ×™×¦×™×¨×ª ××©××¨×ª</a></li>
        <li><a href="/manage"><span class="icon">âœ…</span> × ×™×”×•×œ ××©××¨×ª</a></li>
        <li><a href="/admin"><span class="icon">ğŸ“š</span> ××¨×›×™×•×Ÿ / ×“×©×‘×•×¨×“ ×× ×”×œ</a></li>
        <li><a href="/invoices-page"><span class="icon">ğŸ§¾</span> ×—×©×‘×•× ×™×•×ª</a></li>
        <li><a href="/suppliers-page"><span class="icon">ğŸ·ï¸</span> ×¡×¤×§×™×</a></li>
        <li><a href="/orders-page"><span class="icon">ğŸ“¦</span> ×”×–×× ×•×ª</a></li>
        <li><a href="/dispersals-page"><span class="icon">ğŸš•</span> ×¤×™×–×•×¨×™×</a></li>
    <li><a href="/logout"><span class="icon">ğŸšª</span> ×”×ª× ×ª×§×•×ª</a></li>
      </ul>
    </nav>

    <div class="wrap">
      <h1>×—×©×‘×•× ×™×•×ª</h1>

      <!-- ×”×¢×œ××” -->
      <div class="card">
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="row">
            <div>
              <label>×ª××¨×™×š ××©××¨×ª</label>
              <input type="date" name="date" required />
            </div>
            <div>
              <label>×©× ×¡×¤×§</label>
              <input type="text" name="supplier" placeholder="×œ×“×•×’××”: ×¡×•×¤×¨-×“×¨×™× ×§ ×‘×¢×´×" required />
            </div>
            <label>×§×•×‘×¥ ×—×©×‘×•× ×™×ª (×ª××•× ×” / PDF)</label>
            <div class="file-upload">
<input type="file" id="fileInput" name="file" accept="image/*,application/pdf" style="display:none">
<button type="button" id="fileBtn">×‘×—×¨ ×§×•×‘×¥</button>

              <span id="fileName">×œ× × ×‘×—×¨ ×§×•×‘×¥</span>
            </div>
            <div style="margin-top: 20px;">
              <button type="submit">×”×¢×œ×” ×—×©×‘×•× ×™×ª</button>
            </div>
          </div>
          <p class="muted" id="uploadMsg"></p>
        </form>
      </div>

      <!-- ×—×™×¤×•×©/×¡×™× ×•×Ÿ -->
      <div class="card">
        <form id="filterForm">
          <div class="row">
            <div>
              <label>×—×¤×© ×œ×¤×™ ×ª××¨×™×š</label>
              <input type="date" name="date" />
            </div>
            <div>
              <label>×—×¤×© ×œ×¤×™ ×¡×¤×§</label>
              <input type="text" name="supplier" placeholder="×©× ×¡×¤×§" />
            </div>
          </div>
          <div class="row buttons">
            <button type="submit" class="secondary">×¡× ×Ÿ</button>
            <button type="button" id="clearFilters" class="secondary">× ×§×”</button>
          </div>
        </form>
      </div>

      <!-- ×˜×‘×œ×” -->
      <div class="card">
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th>×ª××¨×™×š</th>
                <th>×¡×¤×§</th>
                <th>×—×©×‘×•× ×™×ª</th>
                <th>×”×¢×œ×”</th>
                <th style="width:160px">×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="pager">
          <button id="prevBtn" class="secondary">â€¹ ×”×§×•×“×</button>
          <span class="muted" id="pageInfo"></span>
          <button id="nextBtn" class="secondary">×”×‘× â€º</button>
        </div>
      </div>
    </div>
  </div>

  <script>
async function uploadInvoice() {
  const fileInput = document.getElementById("fileInput");
  if (!fileInput.files.length) {
    alert("×—×™×™×‘ ×œ×‘×—×•×¨ ×§×•×‘×¥!");
    return;
  }

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  const res = await fetch("/upload-invoice", {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  console.log(data);
}


    const uploadForm = document.getElementById('uploadForm');
    const uploadMsg  = document.getElementById('uploadMsg');
    const filterForm = document.getElementById('filterForm');
    const clearBtn   = document.getElementById('clearFilters');
    const tbody      = document.querySelector('#tbl tbody');
    const prevBtn    = document.getElementById('prevBtn');
    const nextBtn    = document.getElementById('nextBtn');
    const pageInfo   = document.getElementById('pageInfo');

    let state = { date:'', supplier:'', skip:0, limit:20, total:0 };

    // ===== ×¤×•× ×§×¦×™×™×ª CSRF =====
    async function getCsrf() {
      const res = await fetch("/csrf-token", { credentials: "include" });
      const data = await res.json();
      return data.csrfToken;
    }

    // ×”×¢×œ××”
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      // uploadMsg.textContent = '××¢×œ×”...';
      showToast('××¢×œ×”...')
      const fd = new FormData(uploadForm);
      try {
        const csrf = await getCsrf();
const res = await fetch('/upload-invoice', { 
  method:'POST',
  credentials:'include',
  headers:{ 
    
    "CSRF-Token": csrf
  },
  body: fd 
});
        const data = await res.json();
        showToast(data.message || (data.ok ? '×”×•×¢×œ×”' : '×©×’×™××”'))
        if (data.ok) {
          uploadForm.reset();
          fileName.textContent = '×œ× × ×‘×—×¨ ×§×•×‘×¥';
          load();
        }
      } catch (err) {
        uploadMsg.textContent = '×©×’×™××” ×‘×”×¢×œ××”';
      }
    });

    // ×¡×™× ×•×Ÿ
    filterForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(filterForm);
      state.date = fd.get('date') || '';
      state.supplier = fd.get('supplier') || '';
      state.skip = 0;
      load();
    });

    clearBtn.addEventListener('click', () => {
      filterForm.reset();
      state = { ...state, date:'', supplier:'', skip:0 };
      load();
    });

    // ×¢×™××•×“
    prevBtn.addEventListener('click', () => {
      if (state.skip <= 0) return;
      state.skip = Math.max(0, state.skip - state.limit);
      load();
    });
    nextBtn.addEventListener('click', () => {
      if (state.skip + state.limit >= state.total) return;
      state.skip += state.limit;
      load();
    });

    async function load() {
      const params = new URLSearchParams();
      if (state.date) params.set('date', state.date);
      if (state.supplier) params.set('supplier', state.supplier);
      params.set('skip', state.skip);
      params.set('limit', state.limit);

      const csrf = await getCsrf();
      const res = await fetch('/invoices?' + params.toString(), { 
        credentials:'include',
        headers:{ "CSRF-Token": csrf }
      });
      const data = await res.json();
      state.total = data.total || 0;

      tbody.innerHTML = (data.items || []).map(r => `
        <tr>
          <td data-label="×ª××¨×™×š">${escapeHtml(r.shiftDate || '')}</td>
          <td data-label="×¡×¤×§">${escapeHtml(r.supplier || '')}</td>
          <td data-label="×—×©×‘×•× ×™×ª">
            <a href="${r.url}" target="_blank" style="color: white;" title="${escapeHtml(r.originalName || '')}">×¦×¤×™×™×” ×‘×§×•×‘×¥</a>
          </td>
          <td data-label="×”×¢×œ×”">${escapeHtml(r.uploadedBy || '')}</td>
          <td class="actions">
            <button class="secondary delBtn" data-id="${r._id}">××—×§</button>
          </td>
        </tr>
      `).join('');

      const page = Math.floor(state.skip / state.limit) + 1;
      const pages = Math.max(1, Math.ceil(state.total / state.limit));
      pageInfo.textContent = `×¢××•×“ ${page} ××ª×•×š ${pages} (×¡×”×´×› ${state.total})`;

      prevBtn.disabled = state.skip <= 0;
      nextBtn.disabled = state.skip + state.limit >= state.total;

      // ×—×™×‘×•×¨ ×××–×™× ×™× ×œ××—×™×§×”
      tbody.querySelectorAll('.delBtn').forEach(btn=>{
        btn.addEventListener('click',()=>delInvoice(btn.dataset.id));
      });
    }

    async function delInvoice(id) {
      if (!confirm('×œ××—×•×§ ××ª ×”×—×©×‘×•× ×™×ª?')) return;
      const csrf = await getCsrf();
      const res = await fetch('/invoice/' + encodeURIComponent(id), { 
        method:'DELETE',
        credentials:'include',
        headers:{ "CSRF-Token": csrf }
      });
      const data = await res.json();
      alert(data.message || (data.ok ? '× ××—×§' : '×©×’×™××”'));
      if (data.ok) load();
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // ×§×•×‘×¥
    const fileInput = document.getElementById('fileInput');
    const fileBtn = document.getElementById('fileBtn');
    const fileName = document.getElementById('fileName');
    fileBtn.addEventListener("click", () => {
      document.getElementById('fileInput').click();
    })
    fileInput.addEventListener('change', () => {
      fileName.textContent = fileInput.files.length ? fileInput.files[0].name : '×œ× × ×‘×—×¨ ×§×•×‘×¥';
    });

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    load();
  </script>

  <script src="/js/global.js"></script>
  
</body>
</html>
