<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShiftPro • חשבוניות</title>
  <link rel="stylesheet" href="/css/premium.css" />
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script defer type="module" src="/js/ui.js"></script>
</head>
<body class="app-surface">
  <!-- ===== Navbar ===== -->
  <header class="navbar">
    <div class="nav-left">
      <button class="icon-btn only-mobile" id="burger"><svg data-lucide="menu"></svg></button>
      <div class="brand">Shift<span class="brand-accent">Pro</span></div>
    </div>
    <div class="nav-center only-desktop">
      <a href="/" class="nav-link">בית</a>
      <a href="/invoices-page" class="nav-link active">חשבוניות</a>
    </div>
    <div class="nav-right">
      <button class="icon-btn" id="themeToggle"><svg data-lucide="sun"></svg></button>
    </div>
  </header>

  <!-- ===== Mobile Drawer ===== -->
  <aside id="mobileNav" class="drawer mobile-nav">
    <div class="drawer-head">
      <div class="brand">Shift<span class="brand-accent">Pro</span></div>
      <button class="icon-btn" id="closeNav"><svg data-lucide="x"></svg></button>
    </div>
    <nav class="drawer-nav">
      <a href="/" class="drawer-link"><svg data-lucide="home"></svg> דף הבית</a>
      <a href="/invoices-page" class="drawer-link active"><svg data-lucide="receipt"></svg> חשבוניות</a>
      <a href="/suppliers-page" class="drawer-link"><svg data-lucide="tags"></svg> ספקים</a>
      <a href="/orders-page" class="drawer-link"><svg data-lucide="package"></svg> הזמנות</a>
      <a href="/dispersals-page" class="drawer-link"><svg data-lucide="car"></svg> פיזורים</a>
    </nav>
  </aside>

  <!-- ===== Content ===== -->
  <main class="wrap">
    <h1>חשבוניות 🧾</h1>

    <!-- העלאה -->
    <section class="card">
      <form id="uploadForm" enctype="multipart/form-data" class="form-grid">
        <div>
          <label>תאריך משמרת</label>
          <input type="date" name="date" required />
        </div>
        <div>
          <label>שם ספק</label>
          <input type="text" name="supplier" placeholder="לדוגמה: סופר-דרינק" required />
        </div>
        <div class="full">
          <label>קובץ חשבונית (תמונה / PDF)</label>
          <input type="file" name="file" accept="image/*,application/pdf" required />
        </div>
        <div class="actions right full">
          <button class="btn primary" type="submit"><svg data-lucide="upload"></svg> העלה חשבונית</button>
        </div>
      </form>
      <p class="muted" id="uploadMsg"></p>
    </section>

    <!-- חיפוש/סינון -->
    <section class="card">
      <form id="filterForm" class="form-grid">
        <div>
          <label>חפש לפי תאריך</label>
          <input type="date" name="date" />
        </div>
        <div>
          <label>חפש לפי ספק</label>
          <input type="text" name="supplier" placeholder="שם ספק" />
        </div>
        <div class="actions right">
          <button class="btn" type="submit"><svg data-lucide="filter"></svg> סנן</button>
          <button class="btn ghost" type="button" id="clearFilters">נקה</button>
        </div>
      </form>
    </section>

    <!-- טבלה -->
    <section class="card">
      <div class="table-wrap">
        <table class="table" id="tbl" aria-busy="true">
          <thead>
            <tr>
              <th>תאריך</th>
              <th>ספק</th>
              <th>קובץ</th>
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody>
            <tr class="skeleton shimmer"><td colspan="4">&nbsp;</td></tr>
            <tr class="skeleton shimmer"><td colspan="4">&nbsp;</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-actions">
        <button id="prevBtn" class="btn">‹ הקודם</button>
        <span class="muted" id="pageInfo"></span>
        <button id="nextBtn" class="btn">הבא ›</button>
      </div>
    </section>
  </main>

  <div id="toasts" class="toasts"></div>

  <!-- ===== Logic ===== -->
  <script>
    const uploadForm = document.getElementById('uploadForm');
    const uploadMsg  = document.getElementById('uploadMsg');
    const filterForm = document.getElementById('filterForm');
    const clearBtn   = document.getElementById('clearFilters');
    const tbody      = document.querySelector('#tbl tbody');
    const prevBtn    = document.getElementById('prevBtn');
    const nextBtn    = document.getElementById('nextBtn');
    const pageInfo   = document.getElementById('pageInfo');
    let state = { date:'', supplier:'', skip:0, limit:20, total:0 };

    // העלאת חשבונית
    uploadForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); uploadMsg.textContent='מעלה...';
      const fd = new FormData(uploadForm);
      try{
        const res=await fetch('/upload-invoice',{ method:'POST', body:fd });
        const data=await res.json();
        uploadMsg.textContent = data.message || (data.ok?'הועלה ✔':'שגיאה');
        if(data.ok){ uploadForm.reset(); load(); }
      }catch{ uploadMsg.textContent='שגיאה בהעלאה' }
    });

    // סינון
    filterForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd=new FormData(filterForm);
      state.date=fd.get('date')||'';
      state.supplier=fd.get('supplier')||'';
      state.skip=0; load();
    });
    clearBtn.addEventListener('click', ()=>{
      filterForm.reset();
      state={...state, date:'', supplier:'', skip:0};
      load();
    });

    // עימוד
    prevBtn.addEventListener('click', ()=>{
      if(state.skip<=0) return;
      state.skip=Math.max(0,state.skip-state.limit); load();
    });
    nextBtn.addEventListener('click', ()=>{
      if(state.skip+state.limit>=state.total) return;
      state.skip+=state.limit; load();
    });

    async function load(){
      const params = new URLSearchParams();
      if(state.date) params.set('date', state.date);
      if(state.supplier) params.set('supplier', state.supplier);
      params.set('skip', state.skip); params.set('limit', state.limit);
      const res = await fetch('/invoices?'+params.toString());
      const data = await res.json();
      state.total=data.total||0;
      tbody.innerHTML = (data.items||[]).map(r=>`
        <tr>
          <td data-label="תאריך">${escapeHtml(r.shiftDate||'')}</td>
          <td data-label="ספק">${escapeHtml(r.supplier||'')}</td>
          <td data-label="קובץ"><a class="btn primary" href="${r.url}" target="_blank" title="${escapeHtml(r.originalName||'')}">צפייה</a></td>
          <td data-label="פעולות"><button class="btn danger" onclick="delInvoice('${r._id}')">מחק</button></td>
        </tr>`).join('');
      const page = Math.floor(state.skip/state.limit)+1, pages = Math.max(1, Math.ceil(state.total/state.limit));
      pageInfo.textContent = `עמוד ${page} מתוך ${pages}`;
    }

    function escapeHtml(s){ 
      return String(s||'').replace(/[&<>\"']/g, m=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m])); 
    }
    async function delInvoice(id){ 
      if(!confirm('למחוק חשבונית?')) return; 
      await fetch('/invoices/'+id,{method:'DELETE'}); 
      load(); 
    }

    load();
  </script>
</body>
</html>
