<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEW DELI â€¢ ×—×©×‘×•× ×™×•×ª</title>
  <link rel="stylesheet" href="/css/style.css?v=2" />
<meta name="theme-color" content="#2b5329">
  <link rel="icon" href="/icons/icon-512.png" type="image/png">

  <style>
    :root {
      --green: #2b5329; --amber: #ffcb05; --bg: #fbfff6; --border:#e2eadc; --ink:#0a0a0a;
    }
    body { font-family: system-ui, Arial; background: var(--bg); color: var(--ink); padding: clamp(12px,2vw,24px); }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { font-size: clamp(20px, 4vw, 28px); margin-bottom: 16px; color: var(--green); }
    .card { background: #fff; border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.05); margin-bottom: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end; }
    .row label { font-size: 14px; color:#333; display:block; margin-bottom: 6px; }
    input[type="date"], input[type="text"], input[type="file"], select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background:#fff;
    }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; background: var(--green); color: #fff; }
    button.secondary { background: #eee; color: #222; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); }
    th { background: #f5f9f1; text-align: right; }
    .muted { color: #666; font-size: 12px; }
    .actions { display:flex; gap:8px; }
    .pager { display:flex; gap:8px; align-items:center; justify-content: flex-end; margin-top: 8px; }
    @media (max-width: 720px) {
      .row { grid-template-columns: 1fr; }
      table { font-size: 13px; }
      th:nth-child(4), td:nth-child(4) { white-space: nowrap; }
    }
  </style>
</head>
<body>
  <header class="brandbar">
  <span class="brand-title">NEW DELI</span>
  <span class="burger" id="burger">&#9776;</span>
</header>

<nav class="mobile-nav" id="mobileNav">
  <button id="closeNav" class="close-btn">âœ–</button>
  <ul>
    <li><a href="/"><span class="icon">ğŸ </span> ×“×£ ×”×‘×™×ª</a></li>
    <li><a href="/create"><span class="icon">ğŸ—“ï¸</span> ×™×¦×™×¨×ª ××©××¨×ª</a></li>
    <li><a href="/manage"><span class="icon">âœ…</span> × ×™×”×•×œ ××©××¨×ª</a></li>
    <li><a href="/admin-login"><span class="icon">ğŸ“š</span> ××¨×›×™×•×Ÿ / ×“×©×‘×•×¨×“ ×× ×”×œ</a></li>
    <li><a href="/invoices-page"><span class="icon">ğŸ§¾</span> ×—×©×‘×•× ×™×•×ª</a></li>
    <li><a href="/suppliers-page"><span class="icon">ğŸ·ï¸</span> ×¡×¤×§×™×</a></li>
    <li><a href="/orders-page"><span class="icon">ğŸ“¦</span> ×”×–×× ×•×ª</a></li>
    <li><a href="/dispersals-page"><span class="icon">ğŸš•</span> ×¤×™×–×•×¨×™×</a></li>
  </ul>
</nav>
  <div class="wrap">
    <h1>×—×©×‘×•× ×™×•×ª</h1>

    <!-- ×”×¢×œ××” -->
    <div class="card">
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="row">
          <div>
            <label>×ª××¨×™×š ××©××¨×ª</label>
            <input type="date" name="date" required />
          </div>
          <div>
            <label>×©× ×¡×¤×§</label>
            <input type="text" name="supplier" placeholder="×œ×“×•×’××”: ×¡×•×¤×¨-×“×¨×™× ×§ ×‘×¢×´×" required />
          </div>
          <div>
            <label>×§×•×‘×¥ ×—×©×‘×•× ×™×ª (×ª××•× ×” / PDF)</label>
<input type="file" name="file" accept="image/*,application/pdf" required>

<!-- <label>××• ×¦×œ× ×—×©×‘×•× ×™×ª ××”××¦×œ××”</label> -->
<!-- <input type="file" name="file" accept="image/*" capture="environment"> -->

          </div>
          <div>
            <button type="submit">×”×¢×œ×” ×—×©×‘×•× ×™×ª</button>
          </div>
        </div>
        <p class="muted" id="uploadMsg"></p>
      </form>
    </div>

    <!-- ×—×™×¤×•×©/×¡×™× ×•×Ÿ -->
    <div class="card">
      <form id="filterForm">
        <div class="row">
          <div>
            <label>×—×¤×© ×œ×¤×™ ×ª××¨×™×š</label>
            <input type="date" name="date" />
          </div>
          <div>
            <label>×—×¤×© ×œ×¤×™ ×¡×¤×§</label>
            <input type="text" name="supplier" placeholder="×©× ×¡×¤×§" />
          </div>
          <div>
            <button type="submit" class="secondary">×¡× ×Ÿ</button>
          </div>
          <div>
            <button type="button" id="clearFilters" class="secondary">× ×§×”</button>
          </div>
        </div>
      </form>
    </div>

    <!-- ×˜×‘×œ×” -->
    <div class="card">
      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>×ª××¨×™×š</th>
              <th>×¡×¤×§</th>
              <th>×—×©×‘×•× ×™×ª</th>
              <th style="width:160px">×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pager">
        <button id="prevBtn" class="secondary">â€¹ ×”×§×•×“×</button>
        <span class="muted" id="pageInfo"></span>
        <button id="nextBtn" class="secondary">×”×‘× â€º</button>
      </div>
    </div>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const uploadMsg  = document.getElementById('uploadMsg');
    const filterForm = document.getElementById('filterForm');
    const clearBtn   = document.getElementById('clearFilters');
    const tbody      = document.querySelector('#tbl tbody');
    const prevBtn    = document.getElementById('prevBtn');
    const nextBtn    = document.getElementById('nextBtn');
    const pageInfo   = document.getElementById('pageInfo');

    let state = { date:'', supplier:'', skip:0, limit:20, total:0 };

    // ×”×¢×œ××”
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      uploadMsg.textContent = '××¢×œ×”...';
      const fd = new FormData(uploadForm);
      try {
        const res = await fetch('/upload-invoice', { method:'POST', body: fd });
        const data = await res.json();
        uploadMsg.textContent = data.message || (data.ok ? '×”×•×¢×œ×”' : '×©×’×™××”');
        if (data.ok) {
          uploadForm.reset();
          // ×¨×¢× ×•×Ÿ ×”×¨×©×™××” ×œ×¤×™ ×”×¡×™× ×•×Ÿ ×”×§×™×™×
          load();
        }
      } catch (err) {
        uploadMsg.textContent = '×©×’×™××” ×‘×”×¢×œ××”';
      }
    });

    // ×¡×™× ×•×Ÿ
    filterForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(filterForm);
      state.date = fd.get('date') || '';
      state.supplier = fd.get('supplier') || '';
      state.skip = 0;
      load();
    });

    clearBtn.addEventListener('click', () => {
      filterForm.reset();
      state = { ...state, date:'', supplier:'', skip:0 };
      load();
    });

    // ×¢×™××•×“
    prevBtn.addEventListener('click', () => {
      if (state.skip <= 0) return;
      state.skip = Math.max(0, state.skip - state.limit);
      load();
    });
    nextBtn.addEventListener('click', () => {
      if (state.skip + state.limit >= state.total) return;
      state.skip += state.limit;
      load();
    });

    async function load() {
      const params = new URLSearchParams();
      if (state.date) params.set('date', state.date);
      if (state.supplier) params.set('supplier', state.supplier);
      params.set('skip', state.skip);
      params.set('limit', state.limit);

      const res = await fetch('/invoices?' + params.toString());
      const data = await res.json();
      state.total = data.total || 0;

      tbody.innerHTML = (data.items || []).map(r => `
        <tr>
          <td>${escapeHtml(r.shiftDate || '')}</td>
          <td>${escapeHtml(r.supplier || '')}</td>
          <td><a href="${r.url}" target="_blank">${escapeHtml(r.originalName || '×§×•×‘×¥')}</a></td>
          <td class="actions">
            <button onclick="delInvoice('${r._id}')" class="secondary">××—×§</button>
          </td>
        </tr>
      `).join('');

      const page = Math.floor(state.skip / state.limit) + 1;
      const pages = Math.max(1, Math.ceil(state.total / state.limit));
      pageInfo.textContent = `×¢××•×“ ${page} ××ª×•×š ${pages} (×¡×”×´×› ${state.total})`;

      prevBtn.disabled = state.skip <= 0;
      nextBtn.disabled = state.skip + state.limit >= state.total;
    }

    async function delInvoice(id) {
      if (!confirm('×œ××—×•×§ ××ª ×”×—×©×‘×•× ×™×ª?')) return;
      const res = await fetch('/invoice/' + encodeURIComponent(id), { method:'DELETE' });
      const data = await res.json();
      alert(data.message || (data.ok ? '× ××—×§' : '×©×’×™××”'));
      if (data.ok) load();
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    load();
  </script>
  <script src="/js/global.js"></script>

</body>
</html>
