<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NEW DELI • הזמנות יומיות</title>
<link rel="icon" href="/icons/icon-512.png" type="image/png">
<script src="https://unpkg.com/lucide@latest"></script>
<link rel="stylesheet" href="/css/style.css?v=2" />
<script defer src="/js/ui.js"></script>
</head>
<body>
  <div id="globalLoader">
    <div class="spinner"></div>
    <p>טוען נתונים...</p>
  </div>

  <div id="pageContent" style="display:none">
    <header class="brandbar">
      <span class="brand-title">NEW DELI</span>
      <div class="brandbar-right">
        <button id="notifToggle" class="icon-btn"><i data-lucide="bell-off"></i></button>
        <span class="burger" id="burger">&#9776;</span>
        <button id="themeToggle" class="icon-btn">🌙/☀️</button>
      </div>
    </header>

    <nav class="mobile-nav" id="mobileNav">
      <button id="closeNav" class="close-btn">✖</button>
      <ul>
        <li><a href="/"><span class="icon">🏠</span> דף הבית</a></li>
        <li><a href="/create"><span class="icon">🗓️</span> יצירת משמרת</a></li>
        <li><a href="/manage"><span class="icon">✅</span> ניהול משמרת</a></li>
        <li><a href="/admin"><span class="icon">📚</span> ארכיון / דשבורד מנהל</a></li>
        <li><a href="/invoices-page"><span class="icon">🧾</span> חשבוניות</a></li>
        <li><a href="/suppliers-page"><span class="icon">🏷️</span> ספקים</a></li>
        <li><a href="/orders-page"><span class="icon">📦</span> הזמנות</a></li>
        <li><a href="/dispersals-page"><span class="icon">🚕</span> פיזורים</a></li>
    <li><a href="/logout"><span class="icon">🚪</span> התנתקות</a></li>
      </ul>
    </nav>

    <div class="wrap">
      <h1>הזמנות יומיות</h1>

      <!-- בר עליון -->
      <div class="card">
        <form id="loadForm" class="row">
          <div>
            <label>תאריך</label>
            <input type="date" name="date" id="dateInput" required>
            <small id="weekdayHint" class="muted" style="margin-inline-start:8px"></small>
          </div>
          <div>
            <label>&nbsp;</label>
            <button type="submit">טען / צור טופס</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button type="button" id="saveBtn">שמור</button>
          </div>
        </form>
        <p class="muted" id="msg"></p>
      </div>

      <!-- טפסי ספקים -->
      <div id="suppliersWrap"></div>
    </div>
  </div>

  <script>
    const dateInput = document.getElementById('dateInput');
    const loadForm  = document.getElementById('loadForm');
    const saveBtn   = document.getElementById('saveBtn');
    const msg       = document.getElementById('msg');
    const wrap      = document.getElementById('suppliersWrap');

    let current = null;

    // ===== פונקציית CSRF =====
    async function getCsrf() {
      const res = await fetch("/csrf-token", { credentials: "include" });
      const data = await res.json();
      return data.csrfToken;
    }

    // טען/צור טופס ליום
    loadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const date = dateInput.value;
      if (!date) return;
      // msg.textContent = 'טוען...';
        showToast('טוען ...')

      const csrf = await getCsrf();
      const res = await fetch('/orders?date=' + encodeURIComponent(date), {
        credentials: 'include',
        headers: { "CSRF-Token": csrf }
      });
      const data = await res.json();

      if (data.ok) {
        current = data.order;
        render();
        // msg.textContent = 'נטען ✔';
        showToast('נטען ✔')
      } else {
        // msg.textContent = data.message || 'שגיאה';
        showToast(data.message || 'שגיאה')
      }
      setTimeout(()=> msg.textContent='', 1500);
    });

    function weekdayFromYMD(ymd) {
      if (!ymd) return '';
      const [y, m, d] = ymd.split('-').map(Number);
      const dt = new Date(y, m - 1, d);
      return dt.toLocaleDateString('he-IL', { weekday: 'long' });
    }

    function updateWeekdayHint() {
      const ymd = dateInput.value;
      document.getElementById('weekdayHint').textContent =
        ymd ? `(${weekdayFromYMD(ymd)})` : '';
    }
    updateWeekdayHint();
    dateInput.addEventListener('change', updateWeekdayHint);

    // שמירה
    saveBtn.addEventListener('click', async () => {
      if (!current) return;
      collectFromUI();
      // msg.textContent = 'שומר...';
      showToast('שומר...')
      const csrf = await getCsrf();
      const res = await fetch('/orders', {
        method:'POST',
        credentials: 'include',
        headers:{ 
          'Content-Type':'application/json',
          "CSRF-Token": csrf
        },
        body: JSON.stringify({ 
          date: current.date, 
          blocks: current.blocks, 
          notes: current.notes || '' 
        })
      });
      const data = await res.json();
      // msg.textContent = data.ok ? 'נשמר ✔' : (data.message || 'שגיאה בשמירה');
      showToast(data.ok ? 'נשמר ✔' : (data.message || 'שגיאה בשמירה'))
      setTimeout(()=> msg.textContent='', 1500);
    });

    function render(){
      wrap.innerHTML = '';
      if (!current.blocks || !current.blocks.length) {
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.innerHTML = `<p style="text-align:center;color:#666">אין ספקים ליום זה</p>`;
        wrap.appendChild(empty);
        return;
      }

      (current.blocks || []).forEach((b, bi) => {
        const card = document.createElement('div');
        card.className = 'card supplier';
        card.innerHTML = `
          <h3 style="color: white;">${escapeHtml(b.supplier)}</h3>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>מוצר</th>
                  <th>כמה יש</th>
                  <th>להזמין</th>
                  <th>הערות</th>
                </tr>
              </thead>
              <tbody>
                ${b.items.map((it, ii) => `
                  <tr>
                    <td>
                      <div>${escapeHtml(it.name)} <span class="unit">${escapeHtml(it.unit||'')}</span></div>
                    </td>
                    <td><input type="number" class="qty" min="0" step="1" value="${num(it.currentQty)}" data-bi="${bi}" data-ii="${ii}" data-field="currentQty"></td>
                    <td><input type="number" class="qty" min="0" step="1" value="${num(it.toOrderQty)}" data-bi="${bi}" data-ii="${ii}" data-field="toOrderQty"></td>
                    <td><input type="text" value="${escapeAttr(it.notes||'')}" data-bi="${bi}" data-ii="${ii}" placeholder="לדוגמא:" data-field="notes" style="width:100%"></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        wrap.appendChild(card);
      });

      // מאזינים לשינויים
      wrap.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', onFieldChange);
      });
    }

    function onFieldChange(e){
      const bi = +e.target.dataset.bi;
      const ii = +e.target.dataset.ii;
      const field = e.target.dataset.field;
      const v = e.target.type === 'number' ? Number(e.target.value || 0) : String(e.target.value || '');
      if (current?.blocks?.[bi]?.items?.[ii]) {
        current.blocks[bi].items[ii][field] = v;
      }
    }

    function collectFromUI(){
      // כרגע רק המוצרים מתעדכנים ישירות; הערות יום אם תפעיל אותן
    }

    function num(n){ return Number(n||0); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // ברירת מחדל: טען היום
    const today = new Date().toISOString().slice(0,10);
    dateInput.value = today;
  </script>

  <script src="/js/global.js"></script>
  
</body>
</html>
