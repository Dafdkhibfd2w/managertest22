<!DOCTYPE html>


<aside id="mobileNav" class="drawer mobile-nav"><div class="drawer-head"><div class="brand">Shift<span class="brand-accent">Pro</span></div><button class="icon-btn" id="closeNav"><svg data-lucide="x"></svg></button></div><nav class="drawer-nav"><a href="/" class="drawer-link"><svg data-lucide="home"></svg> דף הבית</a><a href="/orders-page" class="drawer-link active"><svg data-lucide="package"></svg> הזמנות</a></nav></aside>


<main class="wrap">
<h1>הזמנות יומיות</h1>


<section class="card">
<form id="loadForm" class="form-grid">
<div>
<label>תאריך</label>
<input type="date" id="dateInput" name="date" required />
<small id="weekdayHint" class="muted"></small>
</div>
<div class="actions right">
<button class="btn" type="submit">טען / צור טופס</button>
<button class="btn primary" type="button" id="saveBtn"><svg data-lucide="save"></svg> שמור</button>
</div>
</form>
<p class="muted" id="msg"></p>
</section>


<!-- Suppliers blocks dynamically inserted -->
<div id="suppliersWrap" class="grid-3"></div>
</main>


<div id="toasts" class="toasts"></div>


<!-- Keep your existing inline JS (selectors preserved) -->
<script>
const dateInput = document.getElementById('dateInput');
const loadForm = document.getElementById('loadForm');
const saveBtn = document.getElementById('saveBtn');
const msg = document.getElementById('msg');
const wrap = document.getElementById('suppliersWrap');
let current = null;


loadForm.addEventListener('submit', async (e)=>{
e.preventDefault(); const date=dateInput.value; if(!date) return; msg.textContent='טוען...';
const res=await fetch('/orders?date='+encodeURIComponent(date)); const data=await res.json();
if(data.ok){ current=data.order; render(); msg.textContent='נטען ✔'; } else { msg.textContent=data.message||'שגיאה'; }
setTimeout(()=> msg.textContent='', 1500);
});


function weekdayFromYMD(ymd){ if(!ymd) return ''; const [y,m,d]=ymd.split('-').map(Number); const dt=new Date(y,m-1,d); return dt.toLocaleDateString('he-IL',{weekday:'long'}) }
function updateWeekdayHint(){ const ymd=dateInput.value; document.getElementById('weekdayHint').textContent = ymd?`(${weekdayFromYMD(ymd)})`:'' }
updateWeekdayHint(); dateInput.addEventListener('change', updateWeekdayHint);


saveBtn.addEventListener('click', async ()=>{ if(!current) return; collectFromUI(); msg.textContent='שומר...';
const res=await fetch('/orders',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ date: current.date, blocks: current.blocks, notes: current.notes||'' })});
const data=await res.json(); msg.textContent = data.ok? 'נשמר ✔' : (data.message||'שגיאה בשמירה'); setTimeout(()=> msg.textContent='', 1500);
});


function render(){ wrap.innerHTML=''; if(!current.blocks||!current.blocks.length){ const empty=document.createElement('div'); empty.className='card'; empty.innerHTML='<p class="muted" style="text-align:center">אין ספקים ליום זה</p>'; wrap.appendChild(empty); return; }
current.blocks.forEach((b,bi)=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=`
<h3>${escapeHtml(b.supplier)}</h3>
<div class="table-wrap"><table class="table"><thead><tr><th>מוצר</th><th>כמה יש</th><th>להזמין</th><th>הערות</th></tr></thead><tbody>
${(b.items||[]).map((it,ii)=>`
<tr>
<td data-label="מוצר">${escapeHtml(it.name)} <span class="muted">${escapeHtml(it.unit||'')}</span></td>
<td data-label="כמה יש"><input type="number" class="qty" min="0" step="1" value="${num(it.currentQty)}" data-bi="${bi}" data-ii="${ii}" data-field="currentQty"></td>
<td data-label="להזמין"><input type="number" class="qty" min="0" step="1" value="${num(it.toOrderQty)}" data-bi="${bi}" data-ii="${ii}" data-field="toOrderQty"></td>
<td data-label="הערות"><input type="text" value="${escapeAttr(it.notes||'')}" data-bi="${bi}" data-ii="${ii}" data-field="notes" style="width:100%"></td>
</tr>`).join('')}
</tbody></table></div>`; wrap.appendChild(card); });
wrap.querySelectorAll('input').forEach(inp=> inp.addEventListener('input', onFieldChange));
}


function onFieldChange(e){ const bi=+e.target.dataset.bi; const ii=+e.target.dataset.ii; const field=e.target.dataset.field; const v=e.target.type==='number'? Number(e.target.value||0): e.target.value; current.blocks[bi].items[ii][field]=v }
function collectFromUI(){ /* data is already in current via onFieldChange */ }
function num(x){ return isFinite(+x)? +x:0 }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])) }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;') }
</script>
</body>
</html>