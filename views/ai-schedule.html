<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>סידור אוטומטי עם AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0E0E0E;--bg-alt:#1C1C1C;--ink:#fff;--ink-muted:#b8b8b8;--card:#1C1C1C;--card-border:#2A2A2A;
      --btn:#00FFA3;--btn-2:#00C2FF;--danger:#ff3b3b;--shadow:0 10px 30px rgba(0,0,0,.35);--r:14px
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:"Heebo",system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink)}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
    h1{margin:0 0 8px; font-size:28px}
    .muted{color:var(--ink-muted)}

    .bar{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:16px 0}
    .btn{appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; color:#000; background:var(--btn); box-shadow:var(--shadow)}
    .btn.secondary{background:var(--btn-2); color:#001}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .card{background:var(--card); border:1px solid var(--card-border); border-radius:var(--r); box-shadow:var(--shadow); padding:16px}
    .grid{display:grid; gap:16px}
    @media (min-width: 900px){ .grid{grid-template-columns: 1.2fr .8fr} }

    .list{max-height: 55vh; overflow:auto; border-radius:12px; border:1px solid var(--card-border)}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 12px; border-bottom:1px solid var(--card-border); text-align:right}
    th{position:sticky; top:0; background:#171717; z-index:1}
    .pill{display:inline-flex; padding:4px 10px; border-radius:999px; background:#101; border:1px solid var(--card-border); gap:6px; align-items:center}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; background:#0b1220; border:1px solid #20304a; font-size:12px}

    /* Skeletons */
    .skeleton{position:relative; overflow:hidden; background:#1b1b1b; border-radius:8px}
    .skeleton::after{content:""; position:absolute; inset:0; background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.06), rgba(255,255,255,0)); transform:translateX(-100%); animation:shimmer 1.2s infinite}
    @keyframes shimmer{100%{transform:translateX(100%)}}
    .sk-line{height:14px}

    /* לוח סידור מוצע */
    .schedule{display:grid; gap:12px}
    @media (min-width: 700px){ .schedule{grid-template-columns: repeat(2, 1fr)} }
    .day{border:1px solid var(--card-border); border-radius:12px; padding:12px; background:#121212}
    .day h3{margin:0 0 10px; font-size:18px}
    .row{display:flex; gap:10px; align-items:center; margin:4px 0}
    .slot{min-width:56px; font-weight:600; color:var(--ink-muted)}
    .names{display:flex; flex-wrap:wrap; gap:6px}

    pre{white-space:pre-wrap; word-break:break-word; background:#0f0f0f; border:1px solid #222; border-radius:12px; padding:12px; max-height:50vh; overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🧠 סידור עבודה אוטומטי</h1>
    <div class="muted" id="weekText">טוען טווח שבוע…</div>

    <div class="bar">
      <button class="btn" id="btnBuild">בנה סידור עם AI</button>
      <button class="btn secondary" id="btnRefresh">רענן העדפות עובדים</button>
      <span class="muted" id="hint"></span>
    </div>

    <div class="grid">
      <div class="card">
        <h3>העדפות עובדים (שבוע הבא)</h3>
        <div class="list" id="prefsList">
          <table>
            <thead>
              <tr>
                <th>שם עובד</th>
                <th>זמינות</th>
                <th>הערות</th>
              </tr>
            </thead>
            <tbody id="prefsBody">
              <!-- rows injected -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>סידור מוצע</h3>
        <div id="scheduleBox" class="schedule">
          <!-- days injected -->
        </div>
        <details style="margin-top:10px">
          <summary>JSON גולמי</summary>
          <pre id="rawOut"></pre>
        </details>
      </div>
    </div>
  </div>

<script>
  // === Utils ===
  async function getCsrf(){
    const r = await fetch('/csrf-token',{credentials:'include'}); const j = await r.json(); return j.csrfToken;
  }
  const daysOrder = ['sun','mon','tue','wed','thu','fri','sat'];
  const daysHeb = {sun:'ראשון',mon:'שני',tue:'שלישי',wed:'רביעי',thu:'חמישי',fri:'שישי',sat:'שבת'};

  function setWeekText(startISO,endISO){
    const s = new Date(startISO).toLocaleDateString('he-IL');
    const e = new Date(endISO).toLocaleDateString('he-IL');
    document.getElementById('weekText').textContent = `שבוע הבא: ${s} – ${e}`;
  }

  function skPrefs(){
    const body = document.getElementById('prefsBody');
    body.innerHTML = '';
    for(let i=0;i<6;i++){
      body.innerHTML += `<tr>
        <td><div class="skeleton sk-line" style="width:120px"></div></td>
        <td><div class="skeleton sk-line" style="width:220px"></div></td>
        <td><div class="skeleton sk-line" style="width:160px"></div></td>
      </tr>`;
    }
  }

  function renderPrefs(list){
    const body = document.getElementById('prefsBody');
    if(!list.length){ body.innerHTML = `<tr><td colspan="3" class="muted">אין הגשות עדיין</td></tr>`; return; }
    body.innerHTML = list.map(row=>{
      const avail = daysOrder.map(d=>{
        const a = (row.shifts?.[d]||[]).map(x=> x==='morning'?'בוקר':'ערב').join(' · ');
        return a?`<span class="tag">${daysHeb[d]}: ${a}</span>`:'';
      }).filter(Boolean).join(' ');
      const notes = Object.entries(row.notes||{}).filter(([,v])=>v).map(([d,v])=>`<div class="muted">• ${daysHeb[d]} – ${v}</div>`).join('');
    console.log(row);

      return `<tr>
        <td>${row.userId?.username || "—"}</td>
        <td>${avail||'<span class="muted">—</span>'}</td>
        <td>${notes||'<span class="muted">—</span>'}</td>
      </tr>`
    }).join('');
    
  }

  function renderSchedule(sch){
    const box = document.getElementById('scheduleBox');
    box.innerHTML = '';
    daysOrder.forEach(d=>{
      const day = sch?.[daysHeb[d]] || sch?.[d] || {}; // תומך גם במפתחי עברית וגם באנגלית
      const morning = day?.בוקר || day?.morning || [];
      const evening = day?.ערב || day?.evening || [];
      box.innerHTML += `<div class="day">
        <h3>${daysHeb[d]}</h3>
        <div class="row"><div class="slot">בוקר</div><div class="names">${(morning||[]).map(n=>`<span class="pill">${n}</span>`).join('')||'<span class="muted">—</span>'}</div></div>
        <div class="row"><div class="slot">ערב</div><div class="names">${(evening||[]).map(n=>`<span class="pill">${n}</span>`).join('')||'<span class="muted">—</span>'}</div></div>
      </div>`
    });
  }

  async function loadPrefs(){
    try{
      document.getElementById('hint').textContent = 'טוען העדפות…';
      skPrefs();
      const r = await fetch('/preferences/next-week',{credentials:'include'});
      const j = await r.json();
      if(!j.ok) throw new Error(j.message||'שגיאה');
      setWeekText(j.weekStart,j.weekEnd);
      renderPrefs(j.submissions||[]);
      document.getElementById('hint').textContent = '';
      return j;
    }catch(e){
      document.getElementById('hint').textContent = '❌ שגיאה בטעינה';
      console.error(e);
      return {ok:false, submissions:[]};
    }
  }

  async function buildAI(){
    try{
      document.getElementById('btnBuild').disabled = true;
      document.getElementById('hint').textContent = 'מריץ AI…';
      const csrf = await getCsrf();
      const r = await fetch('/ai-schedule',{
        method:'POST', credentials:'include', headers:{'Content-Type':'application/json','CSRF-Token':csrf}, body: JSON.stringify({})
      });
      const j = await r.json();
      if(!j.ok){ throw new Error(j.message||'שגיאה בבניית הסידור'); }

      // יכול להגיע מחרוזת JSON או אובייקט
      let sch = j.schedule;
      if(typeof sch === 'string'){
        try{ sch = JSON.parse(sch); }catch{ /* נשאיר raw */ }
      }
      if(typeof sch === 'object'){
        renderSchedule(sch);
        document.getElementById('rawOut').textContent = JSON.stringify(sch,null,2);
      }else{
        document.getElementById('rawOut').textContent = String(j.schedule||'');
      }
      document.getElementById('hint').textContent = '✅ סידור נבנה';
    }catch(e){
      console.error(e);
      document.getElementById('hint').textContent = '❌ שגיאה בהפקה';
    }finally{
      document.getElementById('btnBuild').disabled = false;
    }
  }

  // events
  document.getElementById('btnRefresh').addEventListener('click', loadPrefs);
  document.getElementById('btnBuild').addEventListener('click', buildAI);

  // init
  loadPrefs();
</script>
</body>
</html>
