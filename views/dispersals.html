<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShiftPro • פיזורים</title>
  <link rel="stylesheet" href="/css/premium.css" />
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script defer type="module" src="/js/ui.js"></script>
</head>
<body class="app-surface">
  <header class="navbar">
    <div class="nav-left">
      <button class="icon-btn only-mobile" id="burger"><svg data-lucide="menu"></svg></button>
      <div class="brand">Shift<span class="brand-accent">Pro</span></div>
    </div>
    <div class="nav-center only-desktop">
      <a href="/" class="nav-link">בית</a>
      <a href="/dispersals-page" class="nav-link active">פיזורים</a>
    </div>
    <div class="nav-right">
      <button class="icon-btn" id="themeToggle"><svg data-lucide="sun"></svg></button>
    </div>
  </header>

  <aside id="mobileNav" class="drawer mobile-nav">
    <div class="drawer-head">
      <div class="brand">Shift<span class="brand-accent">Pro</span></div>
      <button class="icon-btn" id="closeNav"><svg data-lucide="x"></svg></button>
    </div>
    <nav class="drawer-nav">
      <a href="/" class="drawer-link"><svg data-lucide="home"></svg> דף הבית</a>
      <a href="/dispersals-page" class="drawer-link active"><svg data-lucide="car"></svg> פיזורים</a>
    </nav>
  </aside>

  <main class="wrap">
    <h1>פיזורים 🚕</h1>

    <section class="card">
      <form id="addForm" class="form-grid">
        <div>
          <label>תאריך משמרת</label>
          <input type="date" name="date" required />
        </div>
        <div>
          <label>מחיר מונית (₪)</label>
          <input type="number" name="price" min="0" step="1" required />
        </div>
        <div>
          <label>נהג / חברה</label>
          <input type="text" name="taxi" placeholder="לדוגמה: אבי / Gett" />
        </div>
        <div>
          <label>מי שילם</label>
          <input type="text" name="payer" placeholder="לדוגמה: הקופה / עומר" />
        </div>
        <div class="actions right full">
          <button class="btn primary" type="submit">שמור פיזור</button>
        </div>
        <p class="muted" id="addMsg"></p>
      </form>
    </section>

    <section class="card">
      <form id="filterForm" class="form-grid">
        <div>
          <label>סינון לפי תאריך</label>
          <input type="date" name="date" />
        </div>
        <div>
          <label>חיפוש לפי נהג</label>
          <input type="text" name="q" placeholder="שם נהג" />
        </div>
        <div class="actions right">
          <button class="btn" type="submit">סנן</button>
          <button class="btn ghost" type="button" id="clearFilters">נקה</button>
        </div>
      </form>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th>תאריך</th>
              <th>מחיר</th>
              <th>נהג / חברה</th>
              <th>שילם</th>
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody>
            <tr class="skeleton shimmer"><td colspan="5">&nbsp;</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-actions">
        <button id="prevBtn" class="btn">‹ הקודם</button>
        <span class="muted" id="pageInfo"></span>
        <button id="nextBtn" class="btn">הבא ›</button>
      </div>
    </section>
  </main>

  <script>
    const addForm=document.getElementById('addForm');
    const addMsg=document.getElementById('addMsg');
    const filterForm=document.getElementById('filterForm');
    const clearBtn=document.getElementById('clearFilters');
    const tbody=document.querySelector('#tbl tbody');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');
    const pageInfo=document.getElementById('pageInfo');

    let allItems=[]; let state={ date:'', q:'', skip:0, limit:20 };

    addForm.addEventListener('submit', async (e)=>{ 
      e.preventDefault(); 
      addMsg.textContent='שומר...'; 
      const fd=new FormData(addForm); 
      const body=Object.fromEntries(fd.entries());
      try{ 
        const res=await fetch('/dispersals',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); 
        const data=await res.json(); 
        if(data.ok){ 
          addMsg.textContent='נשמר ✔'; 
          addForm.reset(); 
          await loadAll(); 
          applyFiltersAndRender(); 
        } else { addMsg.textContent=data.message||'שגיאה'; } 
      }catch{ addMsg.textContent='שגיאה בשמירה' } 
      finally{ setTimeout(()=> addMsg.textContent='',1500) } 
    });

    filterForm.addEventListener('submit', (e)=>{ 
      e.preventDefault(); 
      const fd=new FormData(filterForm); 
      state.date=fd.get('date')||''; 
      state.q=fd.get('q')||''; 
      state.skip=0; 
      applyFiltersAndRender(); 
    });

    clearBtn.addEventListener('click', ()=>{ 
      filterForm.reset(); 
      state={...state, date:'', q:'', skip:0}; 
      applyFiltersAndRender(); 
    });

    prevBtn.addEventListener('click', ()=>{ 
      if(state.skip<=0) return; 
      state.skip=Math.max(0,state.skip-state.limit); 
      render(currentFiltered); 
    });
    nextBtn.addEventListener('click', ()=>{ 
      if(state.skip+state.limit>=currentFiltered.length) return; 
      state.skip+=state.limit; 
      render(currentFiltered); 
    });

    async function loadAll(){ const res=await fetch('/dispersals'); allItems=await res.json(); }
    let currentFiltered=[];
    function applyFiltersAndRender(){ 
      currentFiltered = allItems.filter(item=>{ 
        const byDate = state.date ? (item.shiftDate===state.date) : true; 
        const q=state.q.trim().toLowerCase(); 
        const byQ = !q ? true : ((item.taxi||'').toLowerCase().includes(q)); 
        return byDate && byQ; 
      }); 
      state.skip=0; 
      render(currentFiltered); 
    }

    function render(list){ 
      const start=state.skip, end=Math.min(list.length, start+state.limit); 
      const page=Math.floor(state.skip/state.limit)+1, pages=Math.max(1, Math.ceil(list.length/state.limit));
      tbody.innerHTML = list.slice(start,end).map(r=>
        `<tr>
          <td data-label="תאריך">${escapeHtml(r.shiftDate||'')}</td>
          <td data-label="מחיר">${formatPrice(r.price)}</td>
          <td data-label="נהג / חברה">${escapeHtml(r.taxi||'')}</td>
          <td data-label="שילם">${escapeHtml(r.payer||'')}</td>
          <td data-label="פעולות"><button class="btn danger" onclick="delDisp('${r._id}')">מחק</button></td>
        </tr>`
      ).join('');
      pageInfo.textContent = `עמוד ${page} מתוך ${pages}`;
    }

    async function delDisp(id){ 
      if(!confirm('למחוק רשומה?')) return; 
      await fetch('/dispersals/'+id,{ method:'DELETE' }); 
      await loadAll(); 
      applyFiltersAndRender(); 
    }

function escapeHtml(s) {
  return String(s || '').replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[m]));
}


    function formatPrice(n){ return (Number(n)||0).toLocaleString('he-IL') }

    (async function init(){ await loadAll(); applyFiltersAndRender(); })();
  </script>
</body>
</html>
