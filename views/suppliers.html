<!DOCTYPE html>
<label>מוצרים</label>
<div id="itemsGrid" style="display:grid;gap:12px"></div>
<button type="button" class="btn" id="addItem">הוסף מוצר</button>
</div>
<div class="actions right full">
<button class="btn primary" type="submit">שמור</button>
<button class="btn ghost" type="button" id="resetForm">נקה טופס</button>
</div>
<p class="muted" id="msg"></p>
</form>
</section>


<section class="card">
<div class="table-wrap">
<table class="table" id="tbl">
<thead><tr><th>שם</th><th>ימים</th><th>מוצרים</th><th>פעולות</th></tr></thead>
<tbody>
<tr class="skeleton shimmer"><td colspan="4">&nbsp;</td></tr>
</tbody>
</table>
</div>
</section>
</main>


<script>
const form=document.getElementById('supplierForm');
const formTitle=document.getElementById('formTitle');
const msg=document.getElementById('msg');
const tblBody=document.querySelector('#tbl tbody');
const itemsGrid=document.getElementById('itemsGrid');
const addItemBtn=document.getElementById('addItem');
const nameEl=document.getElementById('name');
const phoneEl=document.getElementById('phone');
const dayEls=Array.from(document.querySelectorAll('.day'));
let editingId=null; let currentList=[];


function dayLabel(n){ return ['א׳','ב׳','ג׳','ד׳','ה׳','ו׳','ש׳'][n]||n }
function addItemRow(name='',unit=''){ const row=document.createElement('div'); row.className='item-row'; row.innerHTML=`
<input type="text" placeholder="שם מוצר" value="${escapeAttr(name)}">
<input type="text" placeholder="יחידה (למשל: קרטון)" value="${escapeAttr(unit)}">
<button type="button" class="btn">מחק</button>`; row.querySelector('button').onclick=()=>row.remove(); itemsGrid.appendChild(row); }
function renderItems(items){ itemsGrid.innerHTML=''; (items||[]).forEach(it=> addItemRow(it.name, it.unit)); if(!items||!items.length) addItemRow('',''); }
addItemBtn.onclick=()=> addItemRow('','');


function collectItems(){ return Array.from(itemsGrid.querySelectorAll('.item-row')).map(r=>{ const [n,u]=r.querySelectorAll('input'); return { name:n.value.trim(), unit:u.value.trim() } }).filter(x=>x.name) }
function collectDays(){ return dayEls.filter(el=>el.checked).map(el=>Number(el.value)) }
function setDays(days){ dayEls.forEach(el=> el.checked = Array.isArray(days) && days.includes(Number(el.value))) }
function resetForm(){ editingId=null; formTitle.textContent='הוסף ספק'; nameEl.value=''; phoneEl.value=''; setDays([]); renderItems([]); msg.textContent='' }
document.getElementById('resetForm').onclick=resetForm;


form.addEventListener('submit', async (e)=>{ e.preventDefault(); const payload={ name:nameEl.value.trim(), phone:phoneEl.value.trim(), days:collectDays(), items:collectItems() };
try{ msg.textContent='שומר...'; let res; if(editingId){ res=await fetch('/suppliers/'+editingId,{ method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) }); } else {
res=await fetch('/suppliers',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) }); }
const data=await res.json(); if(data.ok){ msg.textContent='נשמר ✔'; await loadSuppliers(); resetForm(); } else { msg.textContent=data.message||'שגיאה'; } setTimeout(()=> msg.textContent='',1500);
}catch{ msg.textContent='שגיאה בשמירה' }
});


async function loadSuppliers(){ const res=await fetch('/suppliers'); const data=await res.json(); currentList=data.suppliers||[]; renderTable(); }
function renderTable(){ tblBody.innerHTML = currentList.map(s=>`
<tr>
<td data-label="שם">${escapeHtml(s.name)}</td>
<td data-label="ימים">${(s.days||[]).map(dayLabel).join(', ')}</td>
<td data-label="מוצרים">${(s.items||[]).map(it=>escapeHtml(it.name)).join(', ')}</td>
<td data-label="פעולות"><button class="btn" data-edit="${s._id}">ערוך</button> <button class="btn danger" data-del="${s._id}">מחק</button></td>
</tr>`).join(''); }


async function editSupplier(id){ const s=currentList.find(x=>x._id===id); if(!s) return; editingId=id; formTitle.textContent='עריכת ספק'; nameEl.value=s.name||''; phoneEl.value=s.phone||''; setDays(s.days||[]); renderItems(s.items||[]); }
async function delSupplier(id){ if(!confirm('למחוק ספק?')) return; await fetch('/suppliers/'+id,{ method:'DELETE' }); loadSuppliers(); }


tblBody.addEventListener('click', (e)=>{ const edit=e.target.closest('[data-edit]'); const del=e.target.closest('[data-del]'); if(edit) editSupplier(edit.dataset.edit); if(del) delSupplier(del.dataset.del); });


function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])) }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;') }


loadSuppliers();
</script>
</body>
</html>