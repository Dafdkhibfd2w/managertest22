<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEW DELI • ניהול ספקים</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" href="/icons/icon-512.png" type="image/png">

  <style>
    :root { --green:#2b5329; --bg:#fbfff6; --border:#e2eadc; --ink:#0a0a0a; }
    body { font-family: system-ui, Arial; background: var(--bg); color: var(--ink); padding: clamp(12px,2vw,24px); }
    .wrap { max-width: 1080px; margin: 0 auto; }
    h1 { color: var(--green); margin-bottom: 12px; }
    .card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:16px; }
    .row { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; align-items:end; }
    label { font-size:14px; display:block; margin-bottom:6px; }
    input, select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { border-bottom:1px solid var(--border); padding:8px; text-align:right; }
    th { background:#f5f9f1; }
    .muted { color:#666; font-size:12px; }
    .days { display:flex; gap:8px; flex-wrap: wrap; }
    .actions { display:flex; gap:8px; }
    button { padding:10px 14px; border:0; border-radius:10px; background:var(--green); color:#fff; cursor:pointer; }
    button.secondary { background:#eef1eb; color:#222; }
    button.danger { background:#d9534f; }
    .items-grid { display:grid; grid-template-columns: 2fr 1fr auto; gap:8px; align-items:center; }
    .item-row { display:contents; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ניהול ספקים</h1>

    <!-- טופס הוספה/עריכה -->
    <div class="card">
      <h3 id="formTitle" style="margin-top:0">הוסף ספק</h3>
      <form id="supplierForm">
        <div class="row">
          <div>
            <label>שם ספק</label>
            <input type="text" name="name" id="name" required />
          </div>
          <div>
            <label>טלפון (לא חובה)</label>
            <input type="text" name="phone" id="phone" placeholder="050-0000000" />
          </div>
          <div>
            <label>סטטוס</label>
            <select id="active">
              <option value="true" selected>פעיל</option>
              <option value="false">לא פעיל</option>
            </select>
          </div>
        </div>

        <div class="row" style="grid-template-columns:1fr;">
          <div>
            <label>ימי פעילות</label>
            <div class="days">
              <label><input type="checkbox" class="day" value="0"> א'</label>
              <label><input type="checkbox" class="day" value="1"> ב'</label>
              <label><input type="checkbox" class="day" value="2"> ג'</label>
              <label><input type="checkbox" class="day" value="3"> ד'</label>
              <label><input type="checkbox" class="day" value="4"> ה'</label>
            </div>
          </div>
        </div>

        <div class="row" style="grid-template-columns:1fr;">
          <div>
            <label>מוצרים</label>
            <div class="items-grid" id="itemsGrid">
              <!-- שורות יתווספו דינמית -->
            </div>
            <button type="button" id="addItem" class="secondary" style="margin-top:8px;">הוסף מוצר</button>
          </div>
        </div>

        <div class="row" style="grid-template-columns:auto auto;">
          <div>
            <button type="submit">שמור</button>
          </div>
          <div>
            <button type="button" id="resetForm" class="secondary">נקה טופס</button>
          </div>
        </div>
        <p class="muted" id="msg"></p>
      </form>
    </div>

    <!-- טבלת ספקים -->
    <div class="card">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
        <h3 style="margin:0">ספקים</h3>
        <div>
          <button class="secondary" id="filterActive">הצג פעילים בלבד</button>
          <button class="secondary" id="filterAll">הצג את כולם</button>
        </div>
      </div>
      <div style="overflow:auto; margin-top:10px;">
        <table id="tbl">
          <thead>
            <tr>
              <th>שם</th>
              <th>ימים</th>
              <th>מוצרים</th>
              <th>סטטוס</th>
              <th style="width:160px">פעולות</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <p class="muted">שינויי ספקים ישפיעו על יצירת טופס הזמנות חדש ליום רלוונטי. אם כבר נוצר טופס ליום מסוים, אפשר “לרענן לפי ספקים” (אכין לך כפתור בעתיד אם תרצה).</p>
  </div>

  <script>
    const form = document.getElementById('supplierForm');
    const formTitle = document.getElementById('formTitle');
    const msg  = document.getElementById('msg');
    const tblBody = document.querySelector('#tbl tbody');
    const itemsGrid = document.getElementById('itemsGrid');
    const addItemBtn = document.getElementById('addItem');

    const nameEl = document.getElementById('name');
    const phoneEl = document.getElementById('phone');
    const activeEl = document.getElementById('active');
    const dayEls = Array.from(document.querySelectorAll('.day'));

    const filterActiveBtn = document.getElementById('filterActive');
    const filterAllBtn = document.getElementById('filterAll');

    let editingId = null;
    let currentList = [];

    function dayLabel(n){
      return ['א׳','ב׳','ג׳','ד׳','ה׳','ו׳','ש׳'][n] || n;
    }

    function renderItems(items){
      itemsGrid.innerHTML = '';
      (items || []).forEach((it, idx) => addItemRow(it.name, it.unit));
      if (!items || !items.length) addItemRow('','');
    }

    function addItemRow(name='', unit=''){
      const row = document.createElement('div');
      row.className = 'item-row';
      row.innerHTML = `
        <input type="text" placeholder="שם מוצר" value="${escapeAttr(name)}">
        <input type="text" placeholder="יחידה (למשל: קרטון/ארגז)" value="${escapeAttr(unit)}">
        <button type="button" class="secondary">מחק</button>
      `;
      const delBtn = row.querySelector('button');
      delBtn.onclick = () => row.remove();
      itemsGrid.appendChild(row);
    }

    addItemBtn.onclick = () => addItemRow('','');

    function collectItems(){
      const rows = Array.from(itemsGrid.querySelectorAll('.item-row'));
      return rows.map(r => {
        const [n, u] = r.querySelectorAll('input');
        return { name: n.value.trim(), unit: u.value.trim() };
      }).filter(x => x.name);
    }

    function collectDays(){
      return dayEls.filter(el => el.checked).map(el => Number(el.value));
    }

    function setDays(days){
      dayEls.forEach(el => el.checked = Array.isArray(days) && days.includes(Number(el.value)));
    }

    function resetForm(){
      editingId = null;
      formTitle.textContent = 'הוסף ספק';
      nameEl.value = '';
      phoneEl.value = '';
      activeEl.value = 'true';
      setDays([]);
      renderItems([]);
      msg.textContent = '';
    }

    document.getElementById('resetForm').onclick = resetForm;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        name: nameEl.value.trim(),
        phone: phoneEl.value.trim(),
        days: collectDays(),
        items: collectItems(),
        active: activeEl.value === 'true'
      };
      try {
        msg.textContent = 'שומר...';
        let res;
        if (editingId) {
          res = await fetch('/api/suppliers/' + editingId, {
            method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
        } else {
          res = await fetch('/api/suppliers', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
        }
        const data = await res.json();
        if (data.ok) {
          msg.textContent = 'נשמר ✔';
          await loadSuppliers();
          resetForm();
        } else {
          msg.textContent = data.message || 'שגיאה בשמירה';
        }
        setTimeout(()=> msg.textContent='', 1500);
      } catch (err) {
        msg.textContent = 'שגיאה בשמירה';
      }
    });

    async function loadSuppliers(activeOnly=false){
      const res = await fetch('/api/suppliers' + (activeOnly ? '?active=true' : ''));
      const data = await res.json();
      currentList = data.suppliers || [];
      renderTable();
    }

    function renderTable(){
      tblBody.innerHTML = currentList.map(s => `
        <tr>
          <td>${escapeHtml(s.name)}</td>
          <td>${(s.days||[]).map(dayLabel).join(', ')}</td>
          <td>${(s.items||[]).map(it => escapeHtml(it.name)).join(', ')}</td>
          <td>${s.active ? 'פעיל' : 'לא פעיל'}</td>
          <td class="actions">
            <button class="secondary" data-edit="${s._id}">ערוך</button>
            <button class="secondary" data-toggle="${s._id}">${s.active ? 'השבת' : 'הפעל'}</button>
            <button class="danger" data-del="${s._id}">מחק</button>
          </td>
        </tr>
      `).join('');

      // חיבור אירועים
      tblBody.querySelectorAll('[data-edit]').forEach(btn => btn.onclick = () => editSupplier(btn.dataset.edit));
      tblBody.querySelectorAll('[data-del]').forEach(btn => btn.onclick = () => delSupplier(btn.dataset.del));
      tblBody.querySelectorAll('[data-toggle]').forEach(btn => btn.onclick = () => toggleActive(btn.dataset.toggle));
    }

    async function editSupplier(id){
      const s = currentList.find(x => x._id === id);
      if (!s) return;
      editingId = id;
      formTitle.textContent = 'עריכת ספק';
      nameEl.value = s.name || '';
      phoneEl.value = s.phone || '';
      activeEl.value = s.active ? 'true' : 'false';
      setDays(s.days || []);
      renderItems(s.items || []);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function delSupplier(id){
      if (!confirm('למחוק ספק?')) return;
      await fetch('/api/suppliers/' + id, { method:'DELETE' });
      await loadSuppliers();
    }

    async function toggleActive(id){
      const s = currentList.find(x => x._id === id);
      if (!s) return;
      await fetch('/api/suppliers/' + id + '/active', {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ active: !s.active })
      });
      await loadSuppliers();
    }

    // סינון תצוגה
    filterActiveBtn.onclick = () => loadSuppliers(true);
    filterAllBtn.onclick    = () => loadSuppliers(false);

    // Utils
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // init
    resetForm();
    loadSuppliers();
  </script>
</body>
</html>
